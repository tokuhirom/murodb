name: Crash Resilience Filesystem Matrix

on:
  schedule:
    - cron: '0 5 * * 0' # Weekly on Sunday at 05:00 UTC
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of crash/kill iterations'
        default: '100'

jobs:
  crash-stress-fs:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        filesystem: [ext4, xfs]
    env:
      CRASH_STRESS_ARTIFACT_DIR: /tmp/crash_stress_artifacts
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Build crash stress test
        run: cargo test --test crash_stress --no-run

      - name: Setup XFS loopback filesystem
        if: matrix.filesystem == 'xfs'
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq xfsprogs
          truncate -s 512M /tmp/xfs.img
          mkfs.xfs /tmp/xfs.img
          sudo mkdir -p /mnt/xfs-test
          sudo mount -o loop /tmp/xfs.img /mnt/xfs-test
          sudo chmod 777 /mnt/xfs-test
          echo "CRASH_STRESS_ARTIFACT_DIR=/mnt/xfs-test/artifacts" >> "$GITHUB_ENV"
          echo "TMPDIR=/mnt/xfs-test" >> "$GITHUB_ENV"

      - name: Run crash stress test
        run: |
          mkdir -p "$CRASH_STRESS_ARTIFACT_DIR"
          cargo test --test crash_stress -- \
            --harness --iterations ${{ github.event.inputs.iterations || '100' }}

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: crash-stress-${{ matrix.filesystem }}-artifacts
          path: ${{ env.CRASH_STRESS_ARTIFACT_DIR }}/
          retention-days: 30

      - name: Cleanup XFS loopback
        if: always() && matrix.filesystem == 'xfs'
        run: |
          sudo umount /mnt/xfs-test || true
          rm -f /tmp/xfs.img
